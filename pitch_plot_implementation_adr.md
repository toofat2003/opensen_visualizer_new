# ADR: コースプロットページの実装

## ステータス

承認済み

## 日付

2025/3/31

## コンテキスト

現在のStreamlitアプリケーションに、Trackmanデータを利用したコースプロット機能を追加する必要がある。この機能では、投球データを視覚化し、プロットから特定の投球を選択してCSVファイルとしてエクスポートできるようにする。また、プロット上のポイントをクリックすると、関連する動画リンクに遷移できる機能も要求されている。

## 決定事項

### 1. 基本機能

1. **データソース**
   - `data_trackman` ディレクトリ内のCSVファイルを使用
   - 必要なデータフィールド: Pitcher, Batter, BatterSide, TaggedPitchType, PlateLocSide, PlateLocHeight, c_URL など

2. **クエリ/フィルタリング機能**
   - 投手名、打者名: テキスト入力による検索
   - Balls, Strikes, Outs: 数値によるドロップダウン選択
   - PitchCall, PlayResult: カテゴリによるドロップダウン選択

3. **プロット機能**
   - BTZplot_plotly 関数をベースにしたコースプロット表示
   - 投球タイプごとに異なる色とマーカーを使用
   - 左右打者の区別表示

4. **インタラクティブ機能**
   - ポイントクリックによる動画リンク遷移
   - CSV出力モードでのポイント選択機能

### 2. CSV出力モードの実装

1. **ビジュアル表現**
   - 未選択の投球: 薄い色（透明度0.3）
   - 選択済み投球: 濃い色（透明度1.0）
   - クリックによる選択/選択解除の切り替え

2. **状態管理**
   - Streamlitのセッション状態を使用: `st.session_state.selected_pitches`
   - 選択された投球のインデックスリストを保持

3. **クリックイベント処理**
   - Plotlyのクリックイベントをカスタムイベントに変換
   - URLクエリパラメータによる状態伝達
   - ページのリロードによる状態更新

4. **CSVエクスポート**
   - 選択された投球データのみを抽出
   - Base64エンコードによるダウンロードリンク生成
   - タイムスタンプ付きファイル名で保存

## 実装方法

### 1. ページ構成

```python
def pitch_plot_page():
    st.title("投球コースプロット")
    
    # データロード
    with st.spinner("Trackmanデータを読み込んでいます..."):
        df_trackman = load_trackman_data()
    
    # UI構築とフィルタリング
    # ...
    
    # プロット表示とイベント処理
    # ...
```

### 2. データロード

```python
@st.cache_data(ttl=3600)
def load_trackman_data():
    """
    data_trackmanディレクトリからCSVファイルを読み込み、結合する関数
    """
    # ファイル検索と読み込み処理
    # ...
    
    # データ前処理
    # ...
    
    return combined_df
```

### 3. インタラクティブプロット

```python
def create_interactive_plot_for_csv(df, df_left, df_right, title):
    """
    CSV出力モード用のインタラクティブプロットを作成する
    """
    # プロット構築
    # ...
    
    # クリックイベント処理
    # ...
    
    return fig
```

### 4. クリックイベント処理

```python
# クエリパラメータからの選択状態の更新処理
query_params = st.experimental_get_query_params()
if "selected" in query_params:
    # パラメータから状態を復元
    # ...

# フロントエンドのJavaScriptコード
st.markdown(
    """
    <script>
    document.addEventListener('selected-point', function(e) {
        // クリックイベントをURLパラメータに反映
        // ...
    });
    </script>
    """,
    unsafe_allow_html=True
)
```

## 考慮された代替案

### 1. サーバーサイドイベント処理

- **案**: Streamlit Componentsを開発して、WebSocketやREST APIを通じてクリックイベントをリアルタイムに処理
- **決定**: 複雑さとメンテナンスコストが高いため、よりシンプルなクエリパラメータ方式を採用

### 2. 表形式データ表示

- **案**: プロットと並行してデータテーブルを表示し、チェックボックスで選択
- **決定**: 視覚的インタラクションを優先し、プロット上での直接選択を実装

### 3. ホバーツールチップによる詳細表示

- **案**: ホバー時に詳細情報を表示し、クリックでCSVに追加
- **決定**: 基本情報のみをホバー表示し、クリックを選択/選択解除のトグルとして使用

## 実装上の考慮点

1. **パフォーマンス**
   - 大量のCSVファイルを効率的に処理するためのキャッシュ戦略
   - 必要なカラムのみをロードして処理速度とメモリ使用量を最適化

2. **Streamlitの制約**
   - クライアントサイドとサーバーサイドの通信が制限されている
   - ページリロードを活用した状態伝達によりこの制約を回避

3. **エラー処理**
   - ファイル読み込みやデータ処理中のエラーに対する適切なハンドリング
   - ユーザーへの明確なフィードバック

## 進捗メトリクス

実装の成功を評価するための指標：

1. **機能完全性**: すべての要求機能が実装されているか
2. **パフォーマンス**: データロードと表示の速度が許容範囲内か
3. **ユーザビリティ**: 選択とCSV出力プロセスが直感的か
4. **安定性**: エラー発生率が低く、正常に動作するか

## 将来的な拡張可能性

1. **統計情報の表示**
   - 選択した投球の統計データを動的に表示

2. **詳細表示モード**
   - 選択した投球の詳細情報を表示するサイドパネル

3. **比較モード**
   - 複数選手や期間のデータを重ねて表示する機能

4. **ヒートマップ表示**
   - 投球分布をヒートマップとして可視化する機能
